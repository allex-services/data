!function(a,b,c){c.web_components.data={},a.run(["allex.dialog.Router","allex.dialog",function(a,b){a.register("CRUDCreateNotAllowed",function(a){return b.error({content:"You are not allowed to do create on sink <strong>{{_ctrl.getData().sink_name}}</strong>",data:{sink_name:a}})}),a.register("CRUDNoConfig",function(a,c){return b.error({content:"Unable to find configuration for action <strong>{{_ctrl.getData().action}}</strong> for sink <strong>{{_ctrl.getData().sink_name}}",data:{sink_name:a,action:c}})}),a.register("data.action.edit",function(a,c,d){return b.open({controller:"allex.data.EditItemController"},{action:a,data:c,view:d})})}])}(angular.module("allex.data",["allex.lib","ui.grid","ui.grid.resizeColumns","ui.grid.moveColumns","ui.grid.autoResize"]),ALLEX.lib,ALLEX),function(a,b,c){function d(a,b,c,d){if("create"===d)return!1;var e=d in a?a[d]:b?b[d]:null;return e?"roles"in e?e.roles&&e.roles.length?e.roles.split(",").indexOf(c)>-1:!1:!0:!1}function e(a){if(!a.actionable)return null;var b=a.get("sinkConfiguration"),c=a.get("user"),e=a.get("recordDescriptor").primaryKey,f=b[a.get("name")];if(!e)return null;var g="item_action_order"in f?f.item_action_order:b.item_action_order;return g&&g?g.filter(d.bind(null,b.crud,b.actions,c.get("role"))):null}function f(a,b,c){var d=c in b.crud?b.crud[c]:b.actions[c];return d?(d.widget?d.widget:a[c])||"":""}function g(a,b){var c=e(a);if(c&&c.length){var d=a.get("viewType"),g=angular.extend({},b,ALLEX_CONFIGURATION.VIEW_ACTION_WIDGETS?ALLEX_CONFIGURATION.VIEW_ACTION_WIDGETS[d]:null,a.get("sinkConfiguration")[a.get("name")].actions);if(g)return c.map(f.bind(null,g,a.get("sinkConfiguration"))).join("")}}function h(a,b){var c={required:!0};return a&&a[b.name]&&(c["default"]=a[b.name]),{schema:angular.extend({},b,c)}}function i(a,b,c){a[c.name]=h(b,c)}function j(b,c,d){var e={fields:{}};if(b.fields.forEach(i.bind(null,e.fields,c)),d&&d.form){var f=d.form;a.traverse(f,buildFormDescriptor_extend.bind(null,e.fields))}return e}buildFormDescriptor_extend=function(a,b,c){a[c]=angular.extend({},a[c],b)},c.helpers={itemActions:e,buildActionsWidget:g,buildFormDescriptor:j}}(ALLEX.lib,ALLEX,ALLEX.web_components.data),function(a,b,c,d){var e=c.WEB_COMPONENT,f=e.user.UserDependentMixIn,g=e.routers.RouterSet;a.factory("allexDataViewController",["$parse",function(a){function c(a){b.BasicController.call(this,a),this.el=null,this.config=null,this.name=null,this.sink_name=null,this.data=null,this.viewType=null,this._monitorForGui=null,this._is_remote=null,this.recordDescriptor=null,this.crudable=null,this.actionable=null,f.call(this,a,null,null,a.userid)}return b.inherit(c,b.BasicController),f.addMethods(c),c.prototype.__cleanUp=function(){this._forgetSink(),this.sink_name=null,this.name=null,this.el=null,this.config=null,this.data=null,this.viewType=null,this.recordDescriptor=null,this.crudable=null,this.actionable=null,f.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},c.prototype._fetchSink=function(){var a=this.get("user");this.get("sink_name")&&"loggedin"===a.get("state")&&this.set("sinkRepresentation",this.get("user").getSubSink(this.sink_name))},c.prototype._forgetSink=function(){this._is_remote,this._is_remote=null,this._monitorForGui&&this._monitorForGui.destroy(),this._monitorForGui=null},c.prototype.set_sinkRepresentation=function(a){this._forgetSink();this.get("user");console.log(this.sink_name,a),a?this._got_sinkReady(a):(this.set("data",null),this.set("recordDescriptor",null))},c.prototype._failed=function(){console.log("DJE BA ZAPELO?",arguments)},c.prototype._got_sinkReady=function(a){this.set("data",a.data),console.log("registered sink, data set to",a.data),this._monitorForGui=a.monitorDataForGui(this._updateCB.bind(this)),a.state.listenFor("name",this._readRd.bind(this,a),!0,!1)},c.prototype._readRd=function(a){this.set("recordDescriptor",a.sink.recordDescriptor)},c.prototype.set_recordDescriptor=function(a){this.recordDescriptor=a||null},c.prototype._updateCB=function(){console.log("SAMO DA VIDIM DATU ... ",this.data),this.$apply()},c.prototype.set_userState=function(a){f.prototype.set_userState.call(this,a),this._fetchSink()},c.prototype.get_sinkConfiguration=function(){return ALLEX_CONFIGURATION&&ALLEX_CONFIGURATION.VIEWS?ALLEX_CONFIGURATION.VIEWS[this.get("sink_name")]:null},c.prototype.get_viewConfiguration=function(){var a=this.get("sinkConfiguration");return a?a[this.get("name")]:null},c.prototype.configure=function(a){this.set("sink_name",a.sink),this.set("name",a.name);var b=this.get("sinkConfiguration"),c=this.get("viewConfiguration");if(!b)throw new Error("No view configuration for sink "+a.sink);if(!c)throw new Error("No view configuration for view "+a.name);this.set("viewType",c.view),this.set("config",c.config),this.set("crudable",!!b.crud&&c.crud),this.set("actionable",!!b.actions||!!c.actions),this._fetchSink()},c.prototype.isCRUDAllowed=function(a){var c=this.get("sinkConfiguration").crud;return c&&c[a]?b.isBoolean(c[a])?c[a]:c[a].roles?c[a].roles.split(",").indexOf(this.get("user").get("role"))>-1:!1:!1},c.prototype.getCRUDConfig=function(a){var c=this.get("sinkConfiguration").crud;return b.isBoolean(c[a])?null:c[a]},c.prototype._doAction=function(a,b,c){g.go(a,[b,c,this])},c.prototype._doEdit=function(a,b){var c=this.get("recordDescriptor");return c.primaryKey?void this._doAction(a,"edit",b):void g.go("dialog.error",[{content:"No primary key in record descriptor, can not edit"}])},c.prototype._doRemove=function(a){var b=this.get("recordDescriptor");return b.primaryKey?void g.go("dialog.singleConfirm",[{dialog:{content:"samo da te vidim.."}},this._doActualRemove.bind(this,a)]):void g.go("dialog.error",[{content:"No primary key in record descriptor, can not remove"}])},c.prototype._doActualRemove=function(a){var b=this.get("recordDescriptor"),c=b.primaryKey;this.get("user").getSubSink(this.get("sink_name")).sink.call("delete",{op:"eq",field:c,value:a[c]}).done(this._onRemoveSuccessfull.bind(this,c,a[c]),this._onRemoveFailed.bind(this,c,a[c]))},c.prototype._onRemoveSuccessfull=function(a,b){g.go("dialog.success",[{data:{primaryKey:a,value:b},content:"Record with key <strong>{{_ctrl.settings.data.primaryKey}}: {{_ctrl.settings.data.value}}</strong> was successfuly removed"}])},c.prototype._onRemoveFailed=function(a,b){g.go("dialog.error",[{data:{primaryKey:a,value:b},content:"Failed to remove record with key <strong>{{_ctrl.settings.data.primaryKey}}: {{_ctrl.settings.data.value}}</strong>"}])},c}]),a.controller("allexdataviewController",["$scope","allexDataViewController",function(a,b){new b(a)}]),a.directive("allexDataView",["$parse",function(a){return{restrict:"E",replace:!0,scope:{userid:"@"},templateUrl:"partials/allex_dataservice/partials/dataview.html",controller:"allexdataviewController",link:function(b,c,d){b._ctrl.set("el",c),b._ctrl.configure(a(d.config)(b))}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX,ALLEX.web_components.data),function(a,b,c,d){function e(a,b,c){this.sink_name=c.sink_name;var d=c.config,e=i.buildFormDescriptor(c.recordDescriptor,null,d?angular.extend({},d["#fields"],d.create):null);h.call(this,a,b,{settings:{dialog:{data:null,title:"Create new item: "+c.sink_name,"#content":"jsonform"},button_config:{buttons:{save:{cb:this._onCreate.bind(this,c.doCreate),visible:!1},cancel:{action:"close"}}}},form:e})}function f(a,c){b.BasicController.call(this,a),this._parent=a.$parent._ctrl,this._ready=!1,this._config=null,this._dialog=c,this._rdl=this._parent.attachListener("recordDescriptor",this._onRecordDescriptor.bind(this)),this.label="Add new"}var g=c.WEB_COMPONENT,h=(g.user.UserDependentMixIn,g.forms.WaitingModalUserTwoButtonForm),i=d.helpers,j=g.routers.RouterSet;b.inherit(e,h),e.prototype.__cleanUp=function(){this.sink_name=null,h.prototype.__cleanUp.call(this)},e.prototype._onCreate=function(a){this.set("promise",this.get("user").getSubSink(this.get("sink_name")).sink.call("create",this.get("vals")))};var k={label:"Add new",klass:"btn-default"};b.inherit(f,b.BasicController),f.prototype.__cleanUp=function(){this._dialog=null,this._parent=null,this._ready=!1,this._config=null,this._rdl.destroy(),this._rdl=null,b.BasicController.prototype.__cleanUp.call(this)},f.prototype.isAllowed=function(){return this._ready&&this._allowed},f.prototype.onClick=function(){if(!this._parent.isCRUDAllowed("create"))return j.go("dialog.CRUDCreateNotAllowed",[this.get("sink_name")]);var a=this._parent.getCRUDConfig("create");return a?!b.isBoolean(a)&&a.dialogs?a.dialogs[this.get("role")]?j.go(a.dialogs[this.get("role")]):j.go("dialog.CRUDCreateNotAllowed",[this.get("sink_name")]):void this._dialog.open({controller:"allex.data.CreateNewItemController"},{sink_name:this.get("sink_name"),recordDescriptor:this.get("recordDescriptor"),config:this._parent.get("config")}):j.go("dialog.CRUDNoConfig",[this.get("sink_name"),"create"])},f.prototype._onRecordDescriptor=function(a){this._ready=!!a,this._config=null,this._parent.isCRUDAllowed("create")&&(this._config=angular.extend({},k,this._parent.getCRUDConfig("create")||{})),this.$apply()},f.prototype.get_sink_name=function(){return this._parent.sink_name},f.prototype.get_role=function(){return this._parent.get("user").get("role")},f.prototype.get_recordDescriptor=function(){return this._parent.get("recordDescriptor")},a.controller("allex.data.CreateNewItemController",["$scope","$modalInstance","settings",function(a,b,c){new e(a,b,c)}]),a.controller("allex.data.CreateNewBtnController",["$scope","allex.dialog",function(a,b){new f(a,b)}]),a.directive("allexDataNew",[function(){return{restrict:"E",replace:!0,controller:"allex.data.CreateNewBtnController",scope:!0,template:'<button class="btn" data-ng-class="_ctrl._config.klass" data-ng-show="_ctrl._ready && _ctrl._config" data-ng-click="_ctrl.onClick()">{{_ctrl._config.label}}</button>'}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX,ALLEX.web_components.data),function(a,b,c,d){function e(a,b,c){this.view=c.view;var d=this.view.get("recordDescriptor");if(!d.primaryKey)throw new Error("NO PRIMARY KEY ...");this.primaryKey=d.primaryKey;var e=this.view.get("config"),f=h.buildFormDescriptor(c.view.get("recordDescriptor"),c.data,e?angular.extend({},e["#fields"],e.edit):null);f.fields[this.get("primaryKey")].attribs={"ng-disabled":"1"},g.call(this,a,b,{settings:{dialog:{messages:{autofade:2e3},success:{autoclose:1e3},title:"Edit","#content":"jsonform"},button_config:{buttons:{save:{visible:!1},cancel:{action:"close"}}}},form:f})}var f=c.WEB_COMPONENT,g=(f.user.UserDependentMixIn,f.forms.WaitingModalUserTwoButtonForm),h=d.helpers;b.inherit(e,g),e.prototype.__cleanUp=function(){this.primaryKey=null,this.view=null,g.prototype.__cleanUp.call(this)},e.prototype.dogo=function(){var a=this.get("primaryKey"),b=this.get("user").getSubSink(this.view.get("sink_name")).sink.call("update",{op:"eq",field:a,value:this.vals[a]},this.get("vals"));this.set("promise",b)},a.controller("allex.data.EditItemController",["$scope","$modalInstance","settings",function(a,b,c){new e(a,b,c)}])}(angular.module("allex.data"),ALLEX.lib,ALLEX,ALLEX.web_components.data),function(a,b,c,d){function e(a,b){this.reader=a,b.then(this.onDone.bind(this),this.onError.bind(this),this.onData.bind(this))}function f(a,b){this.sinkname=a,this.data=b||[],this.activeReader=null}e.prototype.destroy=function(){this.reader&&this.reader.activeReader===this&&(this.reader.activeReader=null),this.reader=null},e.prototype.onDone=function(){this.reader&&(this.reader.$apply(),this.destroy())},e.prototype.onError=function(){this.reader&&(this.reader.$apply(),this.destroy())},e.prototype.onData=function(a){this.reader&&this.reader.data.push(a)},f.prototype.__cleanUp=function(){this.data=null,this.sinkname=null},f.prototype.readData=function(){var a=this.get("user");a&&(this.activeReader&&this.activeReader.destroy(),this.data.splice(0),this.activeReader=new e(this,a.execute("readData",this.sinkname,this.createDataReadFilter())))},f.addMethods=function(a){b.inheritMethods(a,f,["readData"])},d.DataReaderJob=e,d.DataReaderMixin=f}(angular.module("allex.data"),ALLEX.lib,ALLEX,ALLEX.web_components.data),function(a,b,c){a.directive("allexDataSetitem",["$parse",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){b._ctrl.set("item",a(d.allexDataSetitem)(b))}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX),function(a,b,c,d){var e=c.WEB_COMPONENT,f=d.helpers,g={edit:'<a href="#" data-ng-click="grid.appScope._ctrl._doEdit(\'dialog.data.action.edit\', row.entity)"><i class="fa fa-pencil-square-o"></i></a>',"delete":'<a href="#" data-ng-click="grid.appScope._ctrl._doRemove(row.entity)"><i class="fa fa-trash-o"></i></a>'};a.factory("allexDataGridController",["$compile",function(a){function c(a){b.BasicController.call(this,a),d.call(this),this._parent=a.$parent._ctrl,this._record_descriptor_l=null}var d=e.interfaces.Element;return b.inherit(c,b.BasicController),d.addMethods(c),c.prototype.__cleanUp=function(){this._record_descriptor_l.destroy(),this._record_descriptor_l=null,this._parent=null,d.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},c.prototype._doAction=function(a,b,c){this._parent._doAction.call(this._parent,a,b,c.toHash(c.fieldNames()))},c.prototype._doEdit=function(a,b){this._parent._doEdit.call(this._parent,a,b.toHash(b.fieldNames()))},c.prototype._doRemove=function(a){this._parent._doRemove.call(this._parent,a.toHash(a.fieldNames()))},c.prototype.get_data=function(){return this._parent.get("data")},c.prototype.build=function(){this._record_descriptor_l=this._parent.attachListener("recordDescriptor",this.set.bind(this,"recordDescriptor"))},c.prototype.releaseGrid=function(){this.get("el").empty()},c.prototype.set_recordDescriptor=function(b){if(this.releaseGrid(),b){this.gridOptions=this.prepareGridOptions(b),this.gridOptions.data=this._parent.get("data");var c=$("<div>").addClass("allex_grid").attr({"data-ui-grid":"_ctrl.gridOptions"}),d=this.get("el");d.append(c),d.removeClass(),d.addClass("allex_grid_container");var e=this._parent.get("config");e&&(e.autoresize&&c.attr("ui-grid-auto-resize",""),e.movablecolumns&&c.attr("ui-grid-move-columns",""),e.resizablecolumns&&c.attr("ui-grid-resize-columns",""),e.container_class&&d.addClass(e.container_class),e.grid_class&&c.addClass(e.grid_class)),a(this.get("el").contents())(this.scope)}},c.prototype.prepareGridOptions=function(a){var b=this._parent.get("config")?this._parent.get("config").grid:null,c=angular.extend({},b),d=c.columnDefs;c.columnDefs=d?d:a.fields.map(this._buildColumnDef.bind(this));var e=this._parent.get("sinkConfiguration"),f=e.action_cell_config&&e.action_cell_config.grid?e.action_cell_config.grid:{};return this._appendCrudAndActions(c.columnDefs,f,this._parent.get("config")),c},c.prototype._appendCrudAndActions=function(a,b,c){var d=f.buildActionsWidget(this._parent,g);if(d&&d.length){var e=angular.extend({name:"Action"},b.action_cell_config,c.action_cell_config,{cellTemplate:d});a.unshift(e)}},c.prototype._buildColumnDef=function(a){return{displayName:a.title,field:a.name}},c}]),a.controller("allexdatagridController",["$scope","allexDataGridController",function(a,b){new b(a)}]),a.directive("allexDataGrid",[function(){return{restrict:"E",replace:!0,scope:!0,transclude:!0,controller:"allexdatagridController",template:'<div class="allex_grid_container"></div>',link:function(a,b,c){a._ctrl.set("el",b)}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX,ALLEX.web_components.data),function(a,b,c){var d={no_item:"<strong>Items unavailable</strong>"};a.directive("allexDataList",["$compile",function(a){return{restrict:"E",scope:!1,transclude:!0,template:'<div class="allex_data_list"><div class="empty" data-ng-hide="_ctrl.data.length"></div><ul class="allex_data_list" data-ng-show="_ctrl.data.length"></ul></div>',replace:!0,link:function(b,c,e){var f=b._ctrl.get("config"),g="$litem in _ctrl.data";f.track&&(g+=" track by "+f.track),f.orderBy&&(g+=" | orderBy:'"+f.orderBy+"'"),f.limitTo;var h=f.item,i=$("<li>"+f.item.content+"</li>");i.attr({"data-ng-repeat":g}),i.attr(h.attrs),f.filter&&i.attr({"data-ng-if":f.filter}),f.list&&f.list.attrs&&c.find("ul").attr(f.list.attrs),c.find("ul").append(i),c.find("div.empty").append(f.empty?f.empty:d.no_item),a(c.contents())(b)}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX),function(a,b,c){function d(a){b.BasicController.call(this,a),this.roles=null,this.allowed=!1,this.sink=null,h.call(this,a)}function e(a){b.BasicController.call(this,a),g.call(this,a),this.config=this.get("data")}var f=c.WEB_COMPONENT,g=f.routers.AllexViewChild,h=(f.routers.RouterSet,f.user.UserDependentMixIn);b.inherit(d,b.BasicController),d.prototype.__cleanUp=function(){this.sink=null,this.allowed=null,this.roles=null,h.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},d.prototype.set_userState=function(a){return h.prototype.set_userState.call(this,a),"loggedin"===a?this.roles?void this.set("allowed",this._isAllowed()):void this.set("allowed",!0):void 0},d.prototype._isAllowed=function(){return this.roles.split(",").indexOf(this.get("user").get("role"))>-1},d.prototype.set_roles=function(a){this.roles=a,this.set("allowed",this._isAllowed()),this.$apply()},d.prototype.set_allowed=function(a){this.allowed=a,this.$apply()},d.prototype.go=function(){this.sink&&!this._isAllowed()},a.controller("allexDataCrudNewController",["$scope",function(a){new d(a)}]),a.directive("allexDataCrudNew",["$compile",function(a){function b(a,b,c){a._ctrl.set("sink",c.sink),c.roles&&c.roles.length&&a._ctrl.set("roles",c.roles),b.html(c.label)}return{restrict:"E",controller:"allexDataCrudNewController",replace:!0,template:'<button class="btn" data-ng-show="_ctrl.allowed" data-ng-click="_ctrl.go()"></button>',link:b}}]);b.inherit(e,b.BasicController),g.addMethods(e),e.prototype.__cleanUp=function(){this.config=null,g.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},a.controller("allexDataCrudViewController",["$scope",function(a){new e(a)}]),a.directive("allexDataCrudView",["$compile",function(a){function b(b,c){var d=$("<allex-data-view>"),e=b._ctrl.get("config"),f={sink:e.sink,name:e.name};d.attr("data-config",JSON.stringify(f)),e.klass&&c.addClass(e.klass),c.append(d),a(c.contents())(b)}return{restrict:"E",controller:"allexDataCrudViewController",replace:!0,template:'<div class="crudview"></div>',link:b}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX);