!function(a,b,c){}(angular.module("allex.data",["allex.lib","ui.grid","ui.grid.autoResize"]),ALLEX.lib,ALLEX),function(a,b,c){a.directive("allexDataView",["$parse","allex.lib.UserDependentMixIn",function(a,c){function d(a){b.BasicController.call(this,a),this.el=null,this.config=null,this.name=null,this.sink_name=null,this.data=null,this.viewType=null,this._monitorForGui=null,this._is_remote=null,this.recordDescriptor=null,this.crudable=null,this.actionable=null,c.call(this,a)}return b.inherit(d,b.BasicController),c.addMethods(d),d.prototype.__cleanUp=function(){this._forgetSink(),this.sink_name=null,this.name=null,this.el=null,this.config=null,this.data=null,this.viewType=null,this.recordDescriptor=null,this.crudable=null,this.actionable=null,c.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},d.prototype._fetchSink=function(){var a=this.get("user");this.get("sink_name")&&"loggedin"===a.get("state")&&this.set("sinkRepresentation",this.get("user").getSubSink(this.sink_name))},d.prototype._forgetSink=function(){this._is_remote,this._is_remote=null,this._monitorForGui&&this._monitorForGui.destroy(),this._monitorForGui=null},d.prototype.set_sinkRepresentation=function(a){this._forgetSink();var b=this.get("user");console.log(this.sink_name,a),a?(this._is_remote=b.isSinkRemote(this.sink_name),this._is_remote&&b.execute("askForRemote",this.sink_name).done(this._got_sinkReady.bind(this,a),this._failed.bind(this)),this._got_sinkReady(a)):(this.set("data",null),this.set("recordDescriptor",null))},d.prototype._failed=function(){console.log("DJE BA ZAPELO?",arguments)},d.prototype._got_sinkReady=function(a){this.set("data",a.data),this._monitorForGui=a.monitorDataForGui(this._updateCB.bind(this)),this.set("recordDescriptor",a.sink.recordDescriptor)},d.prototype.set_recordDescriptor=function(a){console.log("AND RECORD DESCRIPTOR IS ",JSON.stringify(a,null,2)),this.recordDescriptor=a},d.prototype._updateCB=function(){this.$apply()},d.prototype.set_userState=function(a){c.prototype.set_userState.call(this,a),this._fetchSink()},d.prototype.get_sinkConfiguration=function(){return ALLEX_CONFIGURATION&&ALLEX_CONFIGURATION.VIEWS?ALLEX_CONFIGURATION.VIEWS[this.get("sink_name")]:null},d.prototype.get_viewConfiguration=function(){var a=this.get("sinkConfiguration");return a?a[this.get("name")]:null},d.prototype.configure=function(a){this.set("sink_name",a.sink),this.set("name",a.name);var b=this.get("sinkConfiguration"),c=this.get("viewConfiguration");if(!b)throw new Error("No view configuration for sink "+a.sink);if(!c)throw new Error("No view configuration for view "+a.name);this.set("viewType",c.view),this.set("config",c.config),this.set("crudable",!!b.crud&&c.crud),this.set("actionable",!!b.actions&&c.actions),this._fetchSink()},d.prototype.isCRUDAllowed=function(a){var c=this.get("sinkConfiguration").crud;return c&&c[a]?b.isBoolean(c[a])?c[a]:c[a].roles?c[a].roles.split(",").indexOf(this.get("user").get("role"))>-1:!1:!1},d.prototype.getCRUDConfig=function(a){var c=this.get("sinkConfiguration").crud;return b.isBoolean(c[a])?null:c[a]},{restrict:"E",replace:!0,scope:!0,templateUrl:"partials/allex_dataservice/partials/dataview.html",controller:d,link:function(b,c,d){b._ctrl.set("el",c),b._ctrl.configure(a(d.config)(b))}}}]),a.factory("allex.data.CreateNewItemControllerF",["allex.lib.form.WaitingUserModalTwoButtonForm",function(a){function c(b,c,d){a.call(this,b,c,{settings:{dialog:{data:null,title:"Create new item: "+d.sink_name,"#content":"jsonform"},button_config:{buttons:{save:{cb:this._onCreate.bind(this,d.doCreate),visible:!1},cancel:{action:"close"}}}},form:this._buildFormDescriptor(d.recordDescriptor)})}function d(a){return{schema:angular.extend({},a,{required:!0})}}return b.inherit(c,a),c.prototype.__cleanUp=function(){a.prototype.__cleanUp.call(this)},c.prototype._buildFormDescriptor=function(a){return{fields:a.fields.map(d)}},c.prototype.set_form_ready=function(b){a.prototype.set_form_ready.call(this,b),this.settings.setButton("save","visible",b)},c.prototype._onCreate=function(a){this.set("promise",a(this.vals))},c}]),a.controller("allex.data.CreateNewItemController",["$scope","$modalInstance","settings","allex.data.CreateNewItemControllerF",function(a,b,c,d){new d(a,b,c)}]),a.directive("allexDataNew",["$compile","allex.Router","allex.dialog",function(a,c,d){function e(a){b.BasicController.call(this,a),this._parent=a.$parent._ctrl,this._ready=!1,this._config=null,this._rdl=this._parent.attachListener("recordDescriptor",this._onRecordDescriptor.bind(this)),this.label="Add new"}var f={label:"Add new",klass:"btn-default"};return b.inherit(e,b.BasicController),e.prototype.__cleanUp=function(){this._parent=null,this._ready=!1,this._config=null,this._rdl.destroy(),this._rdl=null,b.BasicController.prototype.__cleanUp.call(this)},e.prototype.isAllowed=function(){return this._ready&&this._allowed},e.prototype.onClick=function(){if(!this._parent.isCRUDAllowed("create"))return c.go("dialog.CRUDCreateNotAllowed",[this.get("sink_name")]);var a=this._parent.getCRUDConfig("create");return a?!b.isBoolean(a)&&a.dialogs?a.dialogs[this.get("role")]?c.go(a.dialogs[this.get("role")]):c.go("dialog.CRUDCreateNotAllowed",[this.get("sink_name")]):void d.open({controller:"allex.data.CreateNewItemController"},{sink_name:this.get("sink_name"),recordDescriptor:this.get("recordDescriptor"),doCreate:this.doCreate.bind(this)}):c.go("dialog.CRUDNoConfig",[this.get("sink_name"),"create"])},e.prototype.doCreate=function(a){var c=b.q.defer();return console.log("SAAAAAAAAAAAAAAMO DA TA VIDIM ...",a),c.promise},e.prototype._onRecordDescriptor=function(a){this._ready=!!a,this._config=null,this._parent.isCRUDAllowed("create")&&(this._config=angular.extend({},f,this._parent.getCRUDConfig("create")||{})),this.$apply()},e.prototype.get_sink_name=function(){return this._parent.sink_name},e.prototype.get_role=function(){return this._parent.get("user").get("role")},e.prototype.get_recordDescriptor=function(){return this._parent.get("recordDescriptor")},{restrict:"E",replace:!0,controller:e,scope:!0,template:'<button class="btn" data-ng-class="_ctrl._config.klass" data-ng-show="_ctrl._ready && _ctrl._config" data-ng-click="_ctrl.onClick()">{{_ctrl._config.label}}</button>'}}]),a.run(["allex.Router","allex.dialog",function(a,b){a.register("dialog.CRUDCreateNotAllowed",function(a){return b.error({content:"You are not allowed to do create on sink <strong>{{_ctrl.getData().sink_name}}</strong>",data:{sink_name:a}})}),a.register("dialog.CRUDNoConfig",function(a,c){return b.error({content:"Unable to find configuration for action <strong>{{_ctrl.getData().action}}</strong> for sink <strong>{{_ctrl.getData().sink_name}}",data:{sink_name:a,action:c}})})}])}(angular.module("allex.data"),ALLEX.lib,ALLEX),function(a,b,c){a.directive("allexDataSetitem",["$parse",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){b._ctrl.set("item",a(d.allexDataSetitem)(b))}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX),function(a,b,c){a.directive("allexDataGrid",["allex.lib.interfaces","$compile",function(a,c){function d(c){b.BasicController.call(this,c),a.Element.call(this),this._parent=c.$parent._ctrl,this._record_descriptor_l=null}return b.inherit(d,b.BasicController),a.Element.addMethods(d),d.prototype.__cleanUp=function(){this._record_descriptor_l.destroy(),this._record_descriptor_l=null,this._parent=null,a.Element.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},d.prototype.get_data=function(){return this._parent.get("data")},d.prototype.build=function(){this._record_descriptor_l=this._parent.attachListener("recordDescriptor",this.set.bind(this,"recordDescriptor"))},d.prototype.releaseGrid=function(){this.get("el").empty()},d.prototype.set_recordDescriptor=function(a){if(this.releaseGrid(),a){this.gridOptions=this.prepareGridOptions(a),this.gridOptions.data=this._parent.get("data");var b=$("<div>").addClass("allex_grid").attr("data-ui-grid","_ctrl.gridOptions"),d=this.get("el");d.append(b),d.removeClass(),d.addClass("allex_grid_container");var e=this._parent.get("config");e&&(e.autoresize&&b.attr("ui-grid-auto-resize",""),e.container_class&&d.addClass(e.container_class),e.grid_class&&b.addClass(e.grid_class)),c(this.get("el").contents())(this.scope)}},d.prototype.prepareGridOptions=function(a){var b=this._parent.get("config")?this._parent.get("config").grid:null,c=angular.extend({},b),d=c.columnDefs;return c.columnDefs=a.fields.map(this._buildColumnDef.bind(this,d)),c},d.prototype._buildColumnDef=function(a,b){return angular.extend(a&&a[b.name]||{},{displayName:b.title,field:b.name})},{restrict:"E",replace:!0,scope:!0,transclude:!0,controller:d,template:'<div class="allex_grid_container"></div>',link:function(a,b,c){a._ctrl.set("el",b)}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX),function(a,b,c){var d={no_item:"<strong>Items unavailable</strong>"};a.directive("allexDataList",["$compile",function(a){return{restrict:"E",scope:!1,transclude:!0,template:'<div class="allex_data_list"><div class="empty" data-ng-hide="_ctrl.data.length"></div><ul class="allex_data_list" data-ng-show="_ctrl.data.length"></ul></div>',replace:!0,link:function(b,c,e){var f=b._ctrl.get("config"),g="$litem in _ctrl.data";f.track&&(g+=" track by "+f.track),f.orderBy&&(g+=" | orderBy:'"+f.orderBy+"'"),f.limitTo;var h=f.item,i=$("<li>"+f.item.content+"</li>");i.attr({"data-ng-repeat":g}),i.attr(h.attrs),f.filter&&i.attr({"data-ng-if":f.filter}),f.list&&f.list.attrs&&c.find("ul").attr(f.list.attrs),c.find("ul").append(i),c.find("div.empty").append(f.empty?f.empty:d.no_item),a(c.contents())(b)}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX),function(a,b,c){a.directive("allexDataCrudNew",["$compile","allex.lib.UserDependentMixIn","allex.Router",function(a,c,d){function e(a){b.BasicController.call(this,a),this.roles=null,this.allowed=!1,this.sink=null,c.call(this,a)}return b.inherit(e,b.BasicController),e.prototype.__cleanUp=function(){this.sink=null,this.allowed=null,this.roles=null,c.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},e.prototype.set_userState=function(a){return c.prototype.set_userState.call(this,a),"loggedin"===a?this.roles?void this.set("allowed",this._isAllowed()):void this.set("allowed",!0):void 0},e.prototype._isAllowed=function(){return this.roles.split(",").indexOf(this.get("user").get("role"))>-1},e.prototype.set_roles=function(a){this.roles=a,this.set("allowed",this._isAllowed()),this.$apply()},e.prototype.set_allowed=function(a){this.allowed=a,this.$apply()},e.prototype.go=function(){this.sink&&this._isAllowed()&&console.log("==============>",this.get("user").getSubSink(this.sink))},{restrict:"E",controller:e,replace:!0,template:'<button class="btn" data-ng-show="_ctrl.allowed" data-ng-click="_ctrl.go()"></button>',link:function(a,b,c){a._ctrl.set("sink",c.sink),c.roles&&c.roles.length&&a._ctrl.set("roles",c.roles),b.html(c.label)}}}]),a.directive("allexDataCrudView",["$compile","allex.AllexViewChild",function(a,c){function d(a){b.BasicController.call(this,a),c.call(this,a),this.config=this.get("data")}return b.inherit(d,b.BasicController),c.addMethods(d),d.prototype.__cleanUp=function(){this.config=null,c.prototype.__cleanUp.call(this),b.BasicController.prototype.__cleanUp.call(this)},{restrict:"E",controller:d,replace:!0,template:'<div class="crudview"></div>',link:function(b,c){var d=$("<allex-data-view>"),e=b._ctrl.get("config"),f={sink:e.sink,name:e.name};d.attr("data-config",JSON.stringify(f)),e.klass&&c.addClass(e.klass),c.append(d),a(c.contents())(b)}}}])}(angular.module("allex.data"),ALLEX.lib,ALLEX);